{% extends 'base/base.html' %}

{% block content %}
<style>
body {
    overflow-x: hidden;
    width: 100vw;
    max-width: 100%;
}

html {
    overflow-x: hidden;
}

* {
    max-width: 100%;
    box-sizing: border-box;
}
</style>
<!-- Emergency Hero -->
<div class="text-center mb-8">
    <div class="floating">
        <i class="fas fa-hands-helping text-6xl text-red-400 mb-4"></i>
    </div>
    <h2 class="text-4xl font-bold bg-gradient-to-r from-red-500 to-pink-500 bg-clip-text text-transparent mb-2">
        SafeHer Emergency SOS
    </h2>
    <p class="text-red-600 font-medium">"You are not alone. Help is just one tap away."</p>
</div>

<div class="max-w-lg mx-auto bg-white/95 backdrop-blur-sm p-8 rounded-3xl shadow-2xl border border-red-100">
    <!-- SOS Button Section -->
    <div class="text-center space-y-8">
        <div class="relative">
            <div class="absolute inset-0 bg-red-400 rounded-full animate-ping opacity-20"></div>
            <button id="sos-button" class="relative w-40 h-40 bg-gradient-to-br from-red-500 to-red-600 text-white rounded-full text-5xl font-bold hover:from-red-600 hover:to-red-700 mx-auto block transition-all duration-200 shadow-2xl safe-glow">
                SOS
            </button>
        </div>
        
        <div class="bg-gradient-to-r from-red-50 to-pink-50 p-4 rounded-2xl border border-red-200">
            <p class="text-red-700 font-medium flex items-center justify-center space-x-2">
                <i class="fas fa-map-marker-alt"></i>
                <span>Instant location sharing with authorities</span>
            </p>
        </div>
        
        <div id="sos-status" class="text-center font-medium"></div>
        
        <!-- Empowerment Message -->
        <div class="bg-gradient-to-r from-pink-100 to-rose-100 p-6 rounded-2xl border border-pink-200">
            <div class="flex items-center space-x-3">
                <i class="fas fa-heart text-pink-500 text-2xl"></i>
                <div class="text-left">
                    <p class="text-pink-700 font-bold">You are strong and brave!</p>
                    <p class="text-sm text-pink-600">Every woman deserves to feel safe and protected.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let sosActive = false;
let trackingInterval;

document.getElementById('sos-button').onclick = () => {
    if (sosActive) return;
    
    // Set volume to maximum
    setVolumeToMax();
    
    // Play siren sound
    playSiren();
    
    // Enhanced location request for SOS
    getLocationForSOS().then(location => {
        // Send automatic SMS with location
        sendEmergencySMS(location);
        
        fetch('/api/trigger-sos/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(location)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                sosActive = true;
                
                // Visual feedback
                const sosBtn = document.getElementById('sos-button');
                sosBtn.classList.add('animate-pulse', 'bg-red-800');
                sosBtn.innerHTML = 'ðŸš¨';
                
                // Strong vibration pattern
                if (navigator.vibrate) {
                    // Long strong vibration pattern
                    navigator.vibrate([500, 200, 500, 200, 500, 200, 1000, 300, 1000]);
                    
                    // Continue vibrating every 3 seconds
                    const vibrateInterval = setInterval(() => {
                        if (sosActive) {
                            navigator.vibrate([300, 100, 300, 100, 300]);
                        } else {
                            clearInterval(vibrateInterval);
                        }
                    }, 3000);
                }
                
                document.getElementById('sos-status').innerHTML = 
                    `<div class="bg-red-100 border border-red-300 p-6 rounded-2xl"><div class="flex items-center justify-center space-x-3 text-red-700 mb-3"><i class="fas fa-shield-alt text-2xl"></i><div><p class="font-bold text-lg">SOS ACTIVATED</p><p class="text-sm">SMS sent with location! Help is coming!</p></div></div><p class="text-sm text-red-600">Share tracking: <a href="${data.tracking_url}" class="text-blue-600 underline">${data.tracking_url}</a></p></div>`;
                
                // Start live tracking
                startLiveTracking(data.sos_id);
            }
        });
    }).catch(error => {
        // Even without location, activate SOS
        sosActive = true;
        const sosBtn = document.getElementById('sos-button');
        sosBtn.classList.add('animate-pulse', 'bg-red-800');
        sosBtn.innerHTML = 'ðŸš¨';
        
        document.getElementById('sos-status').innerHTML = 
            `<div class="bg-red-100 border border-red-300 p-6 rounded-2xl"><div class="flex items-center justify-center space-x-3 text-red-700 mb-3"><i class="fas fa-shield-alt text-2xl"></i><div><p class="font-bold text-lg">SOS ACTIVATED</p><p class="text-sm">Location unavailable but SMS sent!</p></div></div></div>`;
        
        // Send SMS without location
        sendEmergencySMS(null);
    });
};

function getLocationForSOS() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            reject('Geolocation not supported');
            return;
        }
        
        navigator.geolocation.getCurrentPosition(
            position => {
                resolve({
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude
                });
            },
            error => {
                console.error('SOS Location error:', error);
                reject(error);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 30000
            }
        );
    });
}

function sendEmergencySMS(location) {
    // Get emergency number from user settings
    const emergencyNumber = localStorage.getItem('emergencyNumber');
    
    if (!emergencyNumber) {
        alert('Please set your emergency number first!');
        return;
    }
    
    let message;
    if (location) {
        // Create Google Maps link
        const mapLink = `https://maps.google.com/?q=${location.latitude},${location.longitude}`;
        
        // Create emergency SMS message with location
        message = `ðŸš¨ EMERGENCY SOS ALERT!\n\nI NEED IMMEDIATE HELP!\n\nMy Location: ${mapLink}\n\nCoordinates: ${location.latitude}, ${location.longitude}\n\nTime: ${new Date().toLocaleString()}\n\nThis is an automated emergency alert from SafeHer app. Please send help or call me immediately!\n\nSTAY SAFE!`;
    } else {
        // Emergency message without location
        message = `ðŸš¨ EMERGENCY SOS ALERT!\n\nI NEED IMMEDIATE HELP!\n\nLocation: Unable to determine\n\nTime: ${new Date().toLocaleString()}\n\nThis is an automated emergency alert from SafeHer app. Please call me immediately!\n\nSTAY SAFE!`;
    }
    
    // Enhanced SMS handling for Android
    const smsLinks = [
        `sms:${emergencyNumber}?body=${encodeURIComponent(message)}`,
        `sms:${emergencyNumber}&body=${encodeURIComponent(message)}`,
        `sms://${emergencyNumber}?body=${encodeURIComponent(message)}`
    ];
    
    // Try multiple SMS methods
    smsLinks.forEach((smsLink, index) => {
        setTimeout(() => {
            try {
                if (index === 0) {
                    window.location.href = smsLink;
                } else {
                    const a = document.createElement('a');
                    a.href = smsLink;
                    a.click();
                }
            } catch (error) {
                console.log(`SMS method ${index + 1} failed:`, error);
            }
        }, index * 500);
    });
    
    console.log(`Emergency SMS sent to ${emergencyNumber}:`, message);
}

function startLiveTracking(sosId) {
    trackingInterval = setInterval(() => {
        navigator.geolocation.getCurrentPosition(
            position => {
                fetch('/api/update-location/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        sos_id: sosId,
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    })
                });
            },
            error => {
                console.log('Tracking location error:', error);
            },
            {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 10000
            }
        );
    }, 5000); // Update every 5 seconds
}

function playSiren() {
    // Create audio context for volume boosting
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    
    // Create audio element
    const audio = new Audio('/media/police_siren.mp3');
    audio.volume = 1.0;
    audio.loop = true;
    
    // Create audio source from the MP3
    const source = audioContext.createMediaElementSource(audio);
    
    // Create gain node for volume boost
    const gainNode = audioContext.createGain();
    gainNode.gain.setValueAtTime(3.0, audioContext.currentTime); // 3x volume boost
    
    // Create compressor for maximum loudness
    const compressor = audioContext.createDynamicsCompressor();
    compressor.threshold.setValueAtTime(-24, audioContext.currentTime);
    compressor.knee.setValueAtTime(30, audioContext.currentTime);
    compressor.ratio.setValueAtTime(12, audioContext.currentTime);
    compressor.attack.setValueAtTime(0.003, audioContext.currentTime);
    compressor.release.setValueAtTime(0.25, audioContext.currentTime);
    
    // Connect audio chain: source -> gain -> compressor -> output
    source.connect(gainNode);
    gainNode.connect(compressor);
    compressor.connect(audioContext.destination);
    
    // Play the boosted audio
    audio.play().catch(error => {
        console.log('Audio play failed:', error);
        playFallbackSiren();
    });
    
    // Stop after 60 seconds
    setTimeout(() => {
        audio.pause();
        audio.currentTime = 0;
    }, 60000);
}

function playFallbackSiren() {
    // Fallback generated siren if MP3 doesn't work
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    
    function createSirenTone(frequency, duration) {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
        oscillator.type = 'square';
        
        gainNode.gain.setValueAtTime(1.0, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + duration);
    }
    
    // Simple hi-lo pattern as fallback
    for (let i = 0; i < 120; i++) {
        setTimeout(() => {
            createSirenTone(i % 2 === 0 ? 1600 : 400, 0.5);
        }, i * 500);
    }
}

function setVolumeToMax() {
    try {
        // Method 1: Wake Lock to prevent sleep
        if ('wakeLock' in navigator) {
            navigator.wakeLock.request('screen').catch(err => console.log('Wake lock failed'));
        }
        
        // Method 2: Media Session for better audio control
        if ('mediaSession' in navigator) {
            navigator.mediaSession.metadata = new MediaMetadata({
                title: 'EMERGENCY SOS ALERT - MAXIMUM VOLUME',
                artist: 'SafeHer Emergency System'
            });
        }
        
        // Method 3: Request audio focus
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        if (audioContext.state === 'suspended') {
            audioContext.resume();
        }
        
        // Method 4: Create silent audio to unlock volume
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.1);
        
        // Show volume instruction
        document.getElementById('sos-status').innerHTML = 
            `<div class="bg-red-100 border border-red-300 p-4 rounded-2xl text-red-700 animate-pulse">
                <i class="fas fa-volume-up mr-2 text-xl"></i>
                <strong>EMERGENCY ALERT ACTIVE!</strong><br>
                <small>If sound is low, quickly press volume up buttons on your device!</small>
            </div>`;
        
        console.log('Audio system optimized for emergency');
    } catch (error) {
        console.log('Volume optimization error:', error);
        document.getElementById('sos-status').innerHTML = 
            `<div class="bg-yellow-100 border border-yellow-300 p-4 rounded-2xl text-yellow-700">
                <i class="fas fa-volume-up mr-2"></i>
                <strong>Please manually increase your device volume for emergency alert!</strong>
            </div>`;
    }
}

// Voice alerts removed - Pure siren only
</script>
{% endblock %}