{% extends 'base/base.html' %}

{% block content %}
<!-- Hero Section -->
<div class="text-center mb-8">
    <div class="floating">
        <i class="fas fa-shield-alt text-6xl text-purple-500 mb-4"></i>
    </div>
    <h2 class="text-3xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-2">
        SafeHer - Report Incident Safely
    </h2>
    <p class="text-purple-600">"Your voice matters. Your safety is our priority."</p>
</div>

<div class="max-w-lg mx-auto bg-white/90 backdrop-blur-sm p-8 rounded-3xl shadow-2xl safe-glow border border-purple-100">
    <!-- Video Container -->
    <div id="video-container" class="mb-6 relative">
        <video id="video" width="100%" height="250" autoplay muted playsinline webkit-playsinline class="rounded-2xl border-4 border-purple-200 shadow-lg"></video>
        <canvas id="canvas" style="display:none;"></canvas>
        <div class="absolute top-4 right-4 bg-white/80 backdrop-blur-sm px-3 py-1 rounded-full text-sm text-purple-600">
            <i class="fas fa-video mr-1"></i>Live
        </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="space-y-4">
        <button id="start-record" class="w-full bg-gradient-to-r from-red-500 to-pink-500 text-white py-4 rounded-2xl font-bold text-lg hover:shadow-xl transition-all transform hover:scale-105">
            <i class="fas fa-record-vinyl mr-2"></i>START RECORDING
        </button>
        
        <button id="stop-record" class="w-full bg-gradient-to-r from-gray-500 to-gray-600 text-white py-4 rounded-2xl font-bold text-lg" disabled>
            <i class="fas fa-stop mr-2"></i>STOP RECORDING
        </button>
        
        <div class="relative">
            <textarea id="description" placeholder="Describe what happened... (Optional)" 
                      class="w-full p-4 border-2 border-purple-200 rounded-2xl focus:border-purple-400 focus:outline-none" rows="3"></textarea>
            <i class="fas fa-pen absolute top-4 right-4 text-purple-300"></i>
        </div>
        
        <button id="submit-report" class="w-full bg-gradient-to-r from-purple-500 to-indigo-500 text-white py-4 rounded-2xl font-bold text-lg hover:shadow-xl transition-all transform hover:scale-105" disabled>
            <i class="fas fa-paper-plane mr-2"></i>SUBMIT REPORT
        </button>
        
        <button id="share-whatsapp" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-4 rounded-2xl font-bold text-lg hover:shadow-xl transition-all transform hover:scale-105" disabled>
            <i class="fab fa-whatsapp mr-2"></i>SHARE ON WHATSAPP
        </button>
    </div>
    
    <div id="status" class="mt-6 text-center font-medium"></div>
    
    <!-- Police Station Map -->
    <div id="police-map" class="mt-6 bg-white rounded-2xl p-4 border border-blue-200 hidden">
        <h3 class="font-bold text-blue-700 mb-3 flex items-center">
            <i class="fas fa-map-marker-alt mr-2"></i>Nearby Police Stations
        </h3>
        <div id="stations-list" class="space-y-2"></div>
    </div>
    
    <!-- AI Detection Status -->
    <div id="ai-status" class="mt-4 bg-gradient-to-r from-green-100 to-emerald-100 p-4 rounded-2xl border border-green-200 hidden">
        <div class="flex items-center space-x-3">
            <i class="fas fa-robot text-green-500 text-xl"></i>
            <div>
                <p class="text-sm text-green-700 font-medium">AI Analysis: Harassment detected</p>
                <p class="text-xs text-green-600">Priority alert sent to authorities</p>
            </div>
        </div>
    </div>
    
    <!-- Manual Location Button -->
    <div id="location-help" class="mt-4 bg-gradient-to-r from-yellow-100 to-orange-100 p-4 rounded-2xl border border-yellow-200 hidden">
        <div class="text-center">
            <p class="text-sm text-yellow-700 font-medium mb-3">Location access needed for emergency alerts</p>
            <button id="manual-location" class="bg-gradient-to-r from-yellow-500 to-orange-500 text-white px-6 py-3 rounded-2xl font-bold hover:shadow-lg transition-all">
                <i class="fas fa-map-marker-alt mr-2"></i>Allow Location Access
            </button>
        </div>
    </div>
    
    <!-- Camera Help -->
    <div class="mt-4 bg-gradient-to-r from-blue-100 to-indigo-100 p-4 rounded-2xl border border-blue-200">
        <div class="flex items-center space-x-3">
            <i class="fas fa-info-circle text-blue-500 text-xl"></i>
            <div>
                <p class="text-sm text-blue-700 font-medium">Not working?</p>
                <p class="text-xs text-blue-600">‚Ä¢ Allow location & camera when asked<br>‚Ä¢ Use Chrome or Safari browser<br>‚Ä¢ Refresh page if needed</p>
            </div>
        </div>
    </div>
    
    <!-- Safety Reminder -->
    <div class="mt-4 bg-gradient-to-r from-purple-100 to-pink-100 p-4 rounded-2xl border border-purple-200">
        <div class="flex items-center space-x-3">
            <i class="fas fa-heart text-pink-500 text-xl"></i>
            <div>
                <p class="text-sm text-purple-700 font-medium">Remember: You're brave for speaking up!</p>
                <p class="text-xs text-purple-600">Your report helps make spaces safer for everyone.</p>
            </div>
        </div>
    </div>
</div>

<script>
let mediaRecorder;
let recordedChunks = [];
let currentLocation = null;

// Get user location with better error handling
function getCurrentLocation() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            reject('Geolocation not supported');
            return;
        }
        
        navigator.geolocation.getCurrentPosition(
            position => {
                currentLocation = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude
                };
                document.getElementById('status').innerHTML = '<div class="text-green-600">‚úÖ Location access granted!</div>';
                loadNearbyStations();
                resolve(currentLocation);
            },
            error => {
                console.error('Location error:', error);
                document.getElementById('status').innerHTML = '<div class="text-red-600">‚ùå Please allow location access and refresh page.</div>';
                reject(error);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            }
        );
    });
}

// Request location on page load
getCurrentLocation().catch(error => {
    console.error('Failed to get location:', error);
});

function loadNearbyStations() {
    if (!currentLocation) return;
    
    fetch(`/api/police-map/?lat=${currentLocation.latitude}&lng=${currentLocation.longitude}`)
        .then(response => response.json())
        .then(data => {
            displayPoliceStations(data.stations);
        });
}

function displayPoliceStations(stations) {
    const mapDiv = document.getElementById('police-map');
    const stationsList = document.getElementById('stations-list');
    
    if (stations.length > 0) {
        mapDiv.classList.remove('hidden');
        stationsList.innerHTML = stations.map(station => `
            <div class="flex justify-between items-center p-3 bg-blue-50 rounded-xl">
                <div>
                    <p class="font-medium text-blue-700">${station.name}</p>
                    <p class="text-sm text-blue-600">${station.distance}km ‚Ä¢ ${station.response_time}min response</p>
                </div>
                <div class="text-right">
                    <div class="flex items-center space-x-1">
                        <div class="w-2 h-2 rounded-full ${station.is_online ? 'bg-green-500' : 'bg-red-500'}"></div>
                        <span class="text-xs ${station.is_online ? 'text-green-600' : 'text-red-600'}">
                            ${station.is_online ? 'Online' : 'Offline'}
                        </span>
                    </div>
                    <div class="text-xs text-yellow-600">‚≠ê ${station.rating}</div>
                </div>
            </div>
        `).join('');
    }
}

// Request location permission first
function requestLocationPermission() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            reject('Geolocation not supported on this device');
            return;
        }
        
        // Request location with high accuracy
        navigator.geolocation.getCurrentPosition(
            position => {
                currentLocation = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude
                };
                document.getElementById('status').innerHTML = '<div class="text-green-600">‚úÖ Location & Camera ready!</div>';
                resolve(currentLocation);
            },
            error => {
                console.error('Location error:', error);
                let errorMsg = 'Location access denied. ';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMsg += 'Please allow location in browser settings.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMsg += 'Location unavailable. Try again.';
                        break;
                    case error.TIMEOUT:
                        errorMsg += 'Location timeout. Try again.';
                        break;
                }
                document.getElementById('status').innerHTML = `<div class="text-red-600">‚ùå ${errorMsg}</div>`;
                reject(error);
            },
            {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 0
            }
        );
    });
}

// Request camera permission for mobile with fallbacks
function requestCameraPermission() {
    // Multiple fallbacks for different browsers
    navigator.getUserMedia = navigator.getUserMedia || 
                           navigator.webkitGetUserMedia || 
                           navigator.mozGetUserMedia || 
                           navigator.msGetUserMedia;
    
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        // Modern browsers
        navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'environment' }, // Use back camera
            audio: true 
        })
        .then(stream => {
            document.getElementById('video').srcObject = stream;
            document.getElementById('status').innerHTML = '<div class="text-green-600">‚úÖ Camera ready! Tap START RECORDING.</div>';
            setupRecording(stream);
        })
        .catch(error => {
            console.log('Modern API failed, trying fallback...');
            tryFallbackCamera();
        });
    } else if (navigator.getUserMedia) {
        // Fallback for older browsers
        tryFallbackCamera();
    } else {
        document.getElementById('status').innerHTML = '<div class="text-orange-600">‚ö†Ô∏è Use Chrome or Safari browser for camera access.</div>';
    }
}

function tryFallbackCamera() {
    navigator.getUserMedia({ video: { facingMode: 'environment' }, audio: true }, 
        function(stream) {
            document.getElementById('video').srcObject = stream;
            document.getElementById('status').innerHTML = '<div class="text-green-600">‚úÖ Camera ready! Tap START RECORDING.</div>';
            setupRecording(stream);
        },
        function(error) {
            console.error('Camera error:', error);
            document.getElementById('status').innerHTML = '<div class="text-red-600">‚ùå Please allow camera access in browser settings and refresh page.</div>';
        }
    );
}

function setupRecording(stream) {
    document.getElementById('start-record').onclick = () => {
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
        
        mediaRecorder.ondataavailable = event => {
            if (event.data.size > 0) recordedChunks.push(event.data);
        };
        
        mediaRecorder.onstop = () => {
            // Create downloadable video file for phone storage
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            window.recordedVideoBlob = blob; // Store for WhatsApp sharing
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `SafeHer_Evidence_${new Date().getTime()}.webm`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            document.getElementById('submit-report').disabled = false;
            document.getElementById('share-whatsapp').disabled = false;
            document.getElementById('status').innerHTML = '<div class="flex items-center justify-center space-x-2 text-green-500"><i class="fas fa-download"></i><span>Video saved! Ready to submit or share.</span></div>';
        };
        
        mediaRecorder.start();
        document.getElementById('start-record').disabled = true;
        document.getElementById('stop-record').disabled = false;
        document.getElementById('status').innerHTML = '<div class="flex items-center justify-center space-x-2 text-red-500"><i class="fas fa-circle animate-pulse"></i><span>Recording Evidence...</span></div>';
    };
    
    document.getElementById('stop-record').onclick = () => {
        mediaRecorder.stop();
        document.getElementById('start-record').disabled = false;
        document.getElementById('stop-record').disabled = true;
    };
}

// Auto-request location and camera permission on page load
async function initializeApp() {
    try {
        // Request location first
        await requestLocationPermission();
        // Then request camera
        requestCameraPermission();
    } catch (error) {
        console.error('Initialization failed:', error);
        document.getElementById('status').innerHTML = 
            '<div class="text-orange-600">‚ö†Ô∏è Please allow location access in browser settings and refresh page.</div>';
    }
}

// Initialize on page load
initializeApp();

// Show manual location button if auto-request fails
setTimeout(() => {
    if (!currentLocation) {
        document.getElementById('location-help').classList.remove('hidden');
    }
}, 3000);

// Manual location request button
document.getElementById('manual-location').onclick = async () => {
    try {
        await requestLocationPermission();
        document.getElementById('location-help').classList.add('hidden');
    } catch (error) {
        alert('Please go to browser settings and allow location access for this site.');
    }
};

// Also try to get location when user interacts
document.addEventListener('click', () => {
    if (!currentLocation) {
        requestLocationPermission().catch(() => {});
    }
}, { once: true });

document.getElementById('submit-report').onclick = async () => {
    // Ensure we have location
    if (!currentLocation) {
        try {
            await getCurrentLocation();
        } catch (error) {
            alert('Location access is required to send emergency alert!');
            return;
        }
    }
    
    const description = document.getElementById('description').value;
    
    // Automatic SMS with location
    sendAutomaticSMS(currentLocation, description);
    
    const blob = new Blob(recordedChunks, { type: 'video/webm' });
    const formData = new FormData();
    formData.append('video', blob, 'incident.webm');
    formData.append('latitude', currentLocation.latitude);
    formData.append('longitude', currentLocation.longitude);
    formData.append('description', description);
    
    fetch('/api/upload-incident/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('status').innerHTML = 
                `<div class="bg-green-100 border border-green-300 p-4 rounded-2xl"><div class="flex items-center space-x-2 text-green-700"><i class="fas fa-shield-check text-xl"></i><div><p class="font-bold">Report Submitted Successfully!</p><p class="text-sm">SMS sent to 9037612009 with your location!</p><p class="text-sm">Nearest Police: ${data.police_station}</p><p class="text-xs mt-1">You're safe now. Help is on the way.</p></div></div></div>`;
            
            // Show AI detection if harassment detected
            if (Math.random() > 0.5) { // Mock AI detection
                document.getElementById('ai-status').classList.remove('hidden');
            }
        } else {
            document.getElementById('status').innerHTML = 
                `<div class="bg-red-100 border border-red-300 p-4 rounded-2xl text-red-700"><i class="fas fa-exclamation-triangle mr-2"></i>Error: ${data.error}</div>`;
        }
    });
};

function sendAutomaticSMS(location, description) {
    if (!location || !location.latitude || !location.longitude) {
        alert('Location not available. Please allow location access.');
        return;
    }
    
    // Get custom emergency number or use default
    const emergencyNumber = localStorage.getItem('emergencyNumber') || '9037612009';
    
    // Create Google Maps link
    const mapLink = `https://maps.google.com/?q=${location.latitude},${location.longitude}`;
    
    // Create SMS message
    const message = `üö® INCIDENT REPORT from SafeHer App

Location: ${mapLink}

Coordinates: ${location.latitude}, ${location.longitude}

Description: ${description}

Time: ${new Date().toLocaleString()}

Video evidence recorded. Please check immediately!

Sent via SafeHer Safety App`;
    
    // Create SMS link
    const smsLink = `sms:${emergencyNumber}?body=${encodeURIComponent(message)}`;
    
    // Open SMS app
    try {
        window.open(smsLink, '_blank');
        // Fallback for mobile
        setTimeout(() => {
            window.location.href = smsLink;
        }, 500);
        
        console.log(`SMS prepared for ${emergencyNumber}:`, message);
        
        // Show success message
        document.getElementById('status').innerHTML = 
            `<div class="bg-blue-100 border border-blue-300 p-4 rounded-2xl"><div class="flex items-center space-x-2 text-blue-700"><i class="fas fa-sms text-xl"></i><div><p class="font-bold">SMS Ready!</p><p class="text-sm">SMS app opened with location to ${emergencyNumber}</p><p class="text-xs mt-1">Tap Send in SMS app to alert emergency contact</p></div></div></div>`;
        
    } catch (error) {
        console.error('SMS error:', error);
        alert(`Failed to open SMS. Please manually send location to ${emergencyNumber}`);
    }
}

// WhatsApp sharing functionality
document.getElementById('share-whatsapp').onclick = () => {
    if (!currentLocation) {
        alert('Location access required!');
        return;
    }
    
    const description = document.getElementById('description').value;
    shareOnWhatsApp(currentLocation, description);
};

function shareOnWhatsApp(location, description) {
    // Get custom emergency number or use default
    const emergencyNumber = localStorage.getItem('emergencyNumber') || '9037612009';
    
    // Create Google Maps link
    const mapLink = `https://maps.google.com/?q=${location.latitude},${location.longitude}`;
    
    // Create WhatsApp message
    const message = `üö® *EMERGENCY ALERT* from SafeHer App

üìç *Location:* ${mapLink}

üìä *Coordinates:* ${location.latitude}, ${location.longitude}

üìù *Description:* ${description}

‚è∞ *Time:* ${new Date().toLocaleString()}

üÜò *Please send help immediately!*

*Video evidence recorded - check attachments*`;
    
    // Try to share video if Web Share API is available
    if (navigator.share && window.recordedVideoBlob) {
        const videoFile = new File([window.recordedVideoBlob], `SafeHer_Evidence_${new Date().getTime()}.webm`, {
            type: 'video/webm'
        });
        
        navigator.share({
            title: 'SafeHer Emergency Alert',
            text: message,
            files: [videoFile]
        }).then(() => {
            console.log('Shared successfully via Web Share API');
        }).catch(error => {
            console.log('Web Share failed, using WhatsApp URL');
            openWhatsAppWithMessage(message, emergencyNumber);
        });
    } else {
        // Fallback to WhatsApp URL
        openWhatsAppWithMessage(message, emergencyNumber);
    }
}

function openWhatsAppWithMessage(message, phoneNumber) {
    // WhatsApp URL scheme
    const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
    
    // Open WhatsApp
    window.open(whatsappURL, '_blank');
    
    // Also try WhatsApp app URL for mobile
    setTimeout(() => {
        window.location.href = `whatsapp://send?phone=${phoneNumber}&text=${encodeURIComponent(message)}`;
    }, 1000);
    
    // Show instructions for video sharing
    document.getElementById('status').innerHTML = `
        <div class="bg-green-100 border border-green-300 p-4 rounded-2xl">
            <div class="text-green-700">
                <p class="font-bold">üì± WhatsApp opened!</p>
                <p class="text-sm mt-2">To share the video:</p>
                <p class="text-xs">1. Tap attachment (üìé) in WhatsApp</p>
                <p class="text-xs">2. Select the downloaded video file</p>
                <p class="text-xs">3. Send to emergency contact</p>
            </div>
        </div>
    `;
}
</script>
{% endblock %}